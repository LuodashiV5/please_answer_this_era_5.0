# åˆ«å†ç”¨ if-else è§£æä¸²å£æŒ‡ä»¤äº†ï¼šæ‰‹æ’¸ä¸€ä¸ªåµŒå…¥å¼ CLIï¼ˆå‘½ä»¤æ¨¡å¼å®æˆ˜ï¼‰å·²ä»˜è´¹

 

**å°†"è¯·æ±‚"å°è£…æˆå¯¹è±¡ï¼Œå®ç°åŠŸèƒ½çš„çƒ­æ’æ‹”ã€å®å‘½ä»¤ï¼ˆä¸€é”®å¤šæ“ï¼‰ä»¥åŠé«˜å¤§ä¸Šçš„ CLI è°ƒè¯•æ¥å£ã€‚**

## ä¸€ã€è¢«"ç¡¬ç¼–ç "ç»‘æ¶çš„å·¥ç¨‹å¸ˆ

è€å¼ æœ€è¿‘æœ‰ç‚¹çƒ¦ã€‚

ä»–æ­£åœ¨åšä¸€ä¸ªæ™ºèƒ½å®¶å±…é¢æ¿é¡¹ç›®ï¼Œæ¿å­ä¸Šæœ‰ 4 ä¸ªç‰©ç†æŒ‰é”®ã€‚äº§å“ç»ç†æœ€å¼€å§‹è¯´å¾—å¾ˆç®€å•ï¼šKey1 å¼€ç¯ï¼ŒKey2 å…³ç¯ï¼ŒKey3 æ§åˆ¶é£æ‰‡ï¼ŒKey4 åˆ‡æ¢æ¨¡å¼ã€‚

è€å¼ å¿ƒæƒ³ï¼Œè¿™è¿˜ä¸ç®€å•ï¼Ÿæ’¸èµ·è¢–å­å°±åœ¨æŒ‰é”®ä¸­æ–­é‡Œå†™æ­»äº†ï¼š

```c
void KEY_IRQHandler(void)
{
    if (key_pressed == KEY1) {
        Led_On();
    } else if (key_pressed == KEY2) {
        Led_Off();
    } else if (key_pressed == KEY3) {
        Fan_Toggle();
    } else if (key_pressed == KEY4) {
        Mode_Switch();
    }
}
```

ä»£ç æäº¤ï¼Œæµ‹è¯•é€šè¿‡ï¼Œè€å¼ ç¾æ»‹æ»‹åœ°å»å–äº†æ¯å’–å•¡ã€‚

ç„¶è€Œå¥½æ™¯ä¸é•¿ã€‚ç¬¬äºŒå¤©æ—©ä¸Šï¼Œäº§å“ç»ç†ç¬‘çœ¯çœ¯åœ°èµ°è¿‡æ¥ï¼š"å¼ å·¥å•Šï¼Œå®¢æˆ·åé¦ˆè¯´é•¿æŒ‰ Key1 èƒ½ä¸èƒ½åŒæ—¶æŠŠç©ºè°ƒå’Œçª—å¸˜ä¹Ÿæ‰“å¼€ï¼Ÿè¿˜æœ‰ï¼ŒçŸ­æŒ‰å’Œé•¿æŒ‰èƒ½ä¸èƒ½åˆ†å¼€å¤„ç†ï¼Ÿ"

è€å¼ çœ‰å¤´ä¸€çš±ï¼Œè¿™äº‹æ²¡é‚£ä¹ˆç®€å•ã€‚

ä»–ä¸å¾—ä¸åœ¨ä¸­æ–­é‡ŒåŠ ä¸Šé•¿æŒ‰æ£€æµ‹é€»è¾‘ï¼Œç„¶åæŠŠç©ºè°ƒæ§åˆ¶å’Œçª—å¸˜æ§åˆ¶çš„ä»£ç ä¹Ÿå¡è¿›æ¥ã€‚æœ¬æ¥æ¸…çˆ½çš„ä¸­æ–­å‡½æ•°ï¼Œå¼€å§‹å˜å¾—è‡ƒè‚¿ï¼š

```c
void KEY_IRQHandler(void)
{
    static uint32_t press_time = 0;

    if (key_pressed == KEY1) {
        if (is_long_press()) {
            Led_On();
            AirCon_On();
            Curtain_Open();
        } else {
            Led_On();
        }
    } else if (key_pressed == KEY2) {
        // åˆæ˜¯ä¸€å †é€»è¾‘...
    }
    // åé¢è¿˜æœ‰...
}
```

ä¸€å‘¨åï¼Œäº§å“ç»ç†åˆæ¥äº†ï¼š"å®¢æˆ·è¯´èƒ½ä¸èƒ½è‡ªå®šä¹‰æŒ‰é”®åŠŸèƒ½ï¼Ÿæ¯”å¦‚æŠŠ Key1 æ”¹æˆæ§åˆ¶çª—å¸˜ï¼Ÿ"

è€å¼ æ²‰é»˜äº†ã€‚

ä»–æ„è¯†åˆ°ï¼Œæ¯æ¬¡éœ€æ±‚å˜æ›´éƒ½è¦æ”¹åº•å±‚é©±åŠ¨ä»£ç ã€‚è€Œä¸”ï¼Œè¿™äº›ä¸šåŠ¡é€»è¾‘å’ŒæŒ‰é”®æ‰«æé€»è¾‘æ…åœ¨ä¸€èµ·ï¼Œè€¦åˆåº¦é«˜å¾—å“äººã€‚

æ›´è®©è€å¼ å¤´ç–¼çš„æ˜¯ä¸²å£è°ƒè¯•ã€‚ä¸ºäº†æ–¹ä¾¿ç°åœºè°ƒè¯•ï¼Œä»–éœ€è¦æ”¯æŒä¸€äº›ä¸²å£æŒ‡ä»¤ï¼Œæ¯”å¦‚è¾“å…¥ `LED_ON` å°±å¼€ç¯ï¼Œè¾“å…¥ `MOTOR_RUN` å°±å¯åŠ¨ç”µæœºã€‚

ç»“æœå†™å‡ºæ¥çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```c
void UART_Handle(char *rx_buf)
{
    if (strcmp(rx_buf, "LED_ON") == 0) {
        Led_On();
    } else if (strcmp(rx_buf, "LED_OFF") == 0) {
        Led_Off();
    } else if (strcmp(rx_buf, "MOTOR_RUN") == 0) {
        Motor_Run();
    } else if (strcmp(rx_buf, "MOTOR_STOP") == 0) {
        Motor_Stop();
    } else if (strcmp(rx_buf, "FAN_ON") == 0) {
        Fan_On();
    } else if (strcmp(rx_buf, "FAN_OFF") == 0) {
        Fan_Off();
    } else if (strcmp(rx_buf, "GET_TEMP") == 0) {
        printf("Temp: %d\n", Get_Temperature());
    } else if (strcmp(rx_buf, "GET_HUMIDITY") == 0) {
        printf("Humidity: %d\n", Get_Humidity());
    }
    // ... åé¢è¿˜æœ‰å‡ åä¸ª
}
```

çœ‹ç€è¿™å¨ä»£ç ï¼Œè€å¼ é™·å…¥äº†æ²‰æ€ã€‚

æ¯æ¬¡åŠ æ–°æŒ‡ä»¤ï¼Œéƒ½è¦æ¥æ”¹è¿™ä¸ªå‡½æ•°ã€‚å­—ç¬¦ä¸²æ¯”è¾ƒæ˜¯ä»å¤´åˆ°å°¾éå†çš„ï¼Œæ•ˆç‡ä½ä¸è¯´ï¼Œä¸‡ä¸€å“ªå¤©æŒ‡ä»¤å¤šäº†ï¼Œè¿™å‡½æ•°æ€•æ˜¯è¦å†™åˆ°å‡ ç™¾è¡Œã€‚

"æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œèƒ½è®©æˆ‘åŠ æ–°åŠŸèƒ½çš„æ—¶å€™ä¸ç”¨æ”¹è€ä»£ç ï¼Ÿ"è€å¼ å¿ƒæƒ³ã€‚

------

## äºŒã€çƒ‚ä»£ç èµæï¼šè¿™äº›å‘ä½ è¸©è¿‡å‡ ä¸ªï¼Ÿ

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥"æ¬£èµ"ä¸€ä¸‹ä¸Šé¢è¿™ç§å†™æ³•çš„é—®é¢˜ã€‚æ¯•ç«Ÿï¼ŒçŸ¥é“é—®é¢˜åœ¨å“ªé‡Œï¼Œæ‰èƒ½ç†è§£è§£å†³æ–¹æ¡ˆçš„ä»·å€¼ã€‚

### é—®é¢˜ä¸€ï¼šè¿åå¼€é—­åŸåˆ™

æ‰€è°“å¼€é—­åŸåˆ™ï¼Œå°±æ˜¯"å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­"ã€‚

çœ‹çœ‹ä¸Šé¢çš„ `UART_Handle` å‡½æ•°ï¼Œæ¯æ¬¡æƒ³åŠ ä¸€ä¸ªæ–°æŒ‡ä»¤ï¼Œéƒ½å¾—æ‰“å¼€è¿™ä¸ªå‡½æ•°ï¼Œåœ¨é‚£ä¸€å † `else if` é‡Œå†åŠ ä¸€æ¡ã€‚è¿™å°±æ˜¯å…¸å‹çš„"å¯¹ä¿®æ”¹å¼€æ”¾"ã€‚

ä½ å¯èƒ½è§‰å¾—è¿™æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ï¼Œä¸å°±åŠ ä¸€è¡Œä»£ç å—ï¼Ÿä½†é—®é¢˜æ˜¯ï¼š

1. 1. **æ”¹è€ä»£ç æ„å‘³ç€é£é™©**ã€‚ä½ ä»¥ä¸ºä½ åªæ˜¯åŠ äº†ä¸€è¡Œï¼Œç»“æœæ‰‹æŠ–å¤šåˆ äº†ä¸ªæ‹¬å·ï¼Œç¼–è¯‘æŠ¥é”™è¿˜å¥½ï¼Œä¸‡ä¸€æ˜¯é€»è¾‘é”™è¯¯å‘¢ï¼ŸåŸæœ¬è·‘å¾—å¥½å¥½çš„åŠŸèƒ½ä¹Ÿè·Ÿç€å‡ºé—®é¢˜ã€‚
2. 2. **å¤šäººåä½œçš„å™©æ¢¦**ã€‚å¦‚æœä½ å’ŒåŒäº‹åŒæ—¶è¦åŠ æ–°æŒ‡ä»¤ï¼Œä½ ä¿©éƒ½å»æ”¹è¿™ä¸ªå‡½æ•°ï¼Œä»£ç å†²çªæ˜¯å¿…ç„¶çš„ã€‚
3. 3. **ä»£ç è¯„å®¡çš„è´Ÿæ‹…**ã€‚æ¯æ¬¡è¯„å®¡éƒ½è¦ review æ•´ä¸ªå¤§å‡½æ•°ï¼Œè€Œä¸æ˜¯åªçœ‹æ–°å¢çš„é‚£éƒ¨åˆ†ã€‚

### é—®é¢˜äºŒï¼šæŸ¥æ‰¾æ•ˆç‡ä½ä¸‹

```c
if (strcmp(rx_buf, "LED_ON") == 0) {
    // ...
} else if (strcmp(rx_buf, "LED_OFF") == 0) {
    // ...
} else if (strcmp(rx_buf, "MOTOR_RUN") == 0) {
    // ...
}
```

è¿™ç§å†™æ³•æ˜¯å…¸å‹çš„ O(N) å¤æ‚åº¦ã€‚å‡è®¾ä½ æœ‰ 50 ä¸ªæŒ‡ä»¤ï¼Œæœ€åæƒ…å†µä¸‹è¦æ¯”è¾ƒ 50 æ¬¡å­—ç¬¦ä¸²ã€‚

ä½ å¯èƒ½ä¼šè¯´ï¼Œ50 æ¬¡æ¯”è¾ƒä¹Ÿå¾ˆå¿«å•Šï¼ŒMCU åˆä¸æ˜¯è·‘ä¸åŠ¨ã€‚

è¯æ˜¯è¿™ä¹ˆè¯´ï¼Œä½†æ¶ä¸ä½ä¸²å£æ•°æ®æ¥å¾—é¢‘ç¹å•Šã€‚å¦‚æœæ˜¯é«˜æ³¢ç‰¹ç‡é€šä¿¡ï¼Œæ¯ç§’å‡ ç™¾æ¡æŒ‡ä»¤çš„æƒ…å†µä¸‹ï¼Œè¿™ç§çº¿æ€§æŸ¥æ‰¾å°±ä¼šæˆä¸ºç“¶é¢ˆã€‚

æ›´ä¼˜é›…çš„åšæ³•æ˜¯ç”¨å“ˆå¸Œè¡¨æˆ–è€…äºŒåˆ†æŸ¥æ‰¾ï¼ŒæŠŠå¤æ‚åº¦é™åˆ° O(1) æˆ– O(logN)ã€‚ä½†åœ¨åµŒå…¥å¼ç¯å¢ƒä¸‹ï¼Œå“ˆå¸Œè¡¨å¤ªé‡äº†ï¼Œæˆ‘ä»¬åé¢ä¼šè®²ä¸€ä¸ªè½»é‡çº§çš„æŠ˜ä¸­æ–¹æ¡ˆã€‚

### é—®é¢˜ä¸‰ï¼šè°ƒç”¨è€…ä¸æ‰§è¡Œè€…å¼ºè€¦åˆ

å›å¤´çœ‹æŒ‰é”®ä¸­æ–­çš„ä»£ç ï¼š

```c
void KEY_IRQHandler(void)
{
    if (key_pressed == KEY1) {
        Led_On();      // ä¸­æ–­ç›´æ¥è°ƒç”¨ä¸šåŠ¡å‡½æ•°
        AirCon_On();
        Curtain_Open();
    }
}
```

ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆè°ƒç”¨è€…ï¼‰ç›´æ¥è°ƒç”¨äº† `Led_On()`ã€`AirCon_On()` è¿™äº›ä¸šåŠ¡å‡½æ•°ï¼ˆæ‰§è¡Œè€…ï¼‰ã€‚è¿™æ„å‘³ç€ï¼š

1. 1. **ä¸­æ–­å‡½æ•°çŸ¥é“å¾—å¤ªå¤šäº†**ã€‚å®ƒä¸ä»…è¦çŸ¥é“æŒ‰é”®è¢«æŒ‰ä¸‹ï¼Œè¿˜è¦çŸ¥é“æŒ‰ä¸‹åè¯¥è°ƒç”¨å“ªäº›å‡½æ•°ã€‚ä¸€æ—¦ä¸šåŠ¡é€»è¾‘å˜äº†ï¼Œä¸­æ–­å‡½æ•°å°±è¦è·Ÿç€æ”¹ã€‚
2. 2. **æ— æ³•å¤ç”¨**ã€‚å¦‚æœå¦ä¸€ä¸ªè§¦å‘æºï¼ˆæ¯”å¦‚å®šæ—¶å™¨ã€ç½‘ç»œæŒ‡ä»¤ï¼‰ä¹Ÿæƒ³æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œå°±å¾—æŠŠè¿™æ®µä»£ç å¤åˆ¶ä¸€éã€‚
3. 3. **ä¸­æ–­é‡Œæ‰§è¡Œæ—¶é—´ä¸å¯æ§**ã€‚`Curtain_Open()` å¦‚æœé‡Œé¢æœ‰å»¶æ—¶æ“ä½œï¼Œç›´æ¥åœ¨ä¸­æ–­é‡Œè°ƒç”¨å°±ä¼šå¡æ­»ç³»ç»Ÿã€‚

### é—®é¢˜å››ï¼šåŠŸèƒ½éš¾ä»¥ç»„åˆ

å‡è®¾å®¢æˆ·è¯´ï¼š"æˆ‘æƒ³ä¸€é”®æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šå¼€ç¯ã€å¼€ç©ºè°ƒã€å…³çª—å¸˜ã€æŠŠæ¸©åº¦è®¾åˆ° 26 åº¦ã€‚"

ç”¨ç°åœ¨è¿™ç§å†™æ³•ï¼Œä½ åªèƒ½è¿™ä¹ˆå¹²ï¼š

```c
void OneKey_Action(void)
{
    Led_On();
    AirCon_On();
    Curtain_Close();
    AirCon_SetTemp(26);
}
```

ç„¶ååœ¨æŸä¸ª `else if` é‡Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

ä½†å¦‚æœå®¢æˆ·ä¸‹æ¬¡è¯´ï¼š"æˆ‘æƒ³æ”¹æˆå¼€ç¯ã€å¼€é£æ‰‡ã€å¼€çª—å¸˜"å‘¢ï¼Ÿä½ åˆå¾—æ”¹ä»£ç ã€ç¼–è¯‘ã€çƒ§å½•ã€‚

æ›´é«˜çº§çš„éœ€æ±‚æ˜¯ï¼šè®©ç”¨æˆ·è‡ªå·±é€šè¿‡ä¸²å£"å½•åˆ¶"ä¸€ç³»åˆ—æ“ä½œï¼Œç„¶åä¸€é”®å›æ”¾ã€‚è¿™åœ¨å·¥ä¸šè‡ªåŠ¨åŒ–é¢†åŸŸå«"ç¤ºæ•™æ¨¡å¼"ï¼Œæ“ä½œå‘˜æ“ä½œä¸€éï¼Œæœºå™¨è®°ä½äº†ï¼Œä»¥åå°±èƒ½è‡ªåŠ¨é‡å¤ã€‚

ç”¨ `if-else` ç¡¬ç¼–ç ï¼Œæ ¹æœ¬å®ç°ä¸äº†è¿™ç§åŠ¨æ€é…ç½®ã€‚

------

**é—®é¢˜è®²æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥è¯¥è¯·æ•‘å…µäº†ã€‚**

------

## ä¸‰ã€æ•‘æ˜Ÿç™»åœºï¼šå‘½ä»¤æ¨¡å¼ï¼ˆæŠŠ"åŠ¨ä½œ"å˜æˆ"æ•°æ®"ï¼‰

### 3.1 ä»ç‚¹èœè¯´èµ·

ç†è§£å‘½ä»¤æ¨¡å¼ï¼Œæœ‰ä¸ªç‰¹åˆ«æ¥åœ°æ°”çš„ç±»æ¯”ï¼šå»é¥­åº—åƒé¥­ã€‚

ä½ é¥¿äº†ï¼Œæƒ³åƒä¸€ç¢—çº¢çƒ§ç‰›è‚‰é¢ã€‚ä½ ä¼šæ€ä¹ˆåšï¼Ÿ

**æ™®é€šé’å¹´çš„åšæ³•**ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ `if-else` å†™æ³•ï¼‰ï¼š
ç›´æ¥å†²è¿›å¨æˆ¿ï¼Œæ‹ç€å¨å¸ˆçš„è‚©è†€è¯´ï¼š"å“¥ä»¬å„¿ï¼Œç»™æˆ‘æ•´ç¢—çº¢çƒ§ç‰›è‚‰é¢ï¼Œç‰›è‚‰å¤šæ”¾ç‚¹ï¼Œé¢ç…®ç¡¬ä¸€ç‚¹ã€‚"

å¨å¸ˆä¸€è„¸æ‡µé€¼ï¼š"ä½ è°å•Šï¼Ÿæˆ‘æ­£å¿™ç€å‘¢ï¼è€Œä¸”ä½ è¿™éœ€æ±‚æˆ‘è®°ä¸ä½ã€‚"

**æ–‡è‰ºé’å¹´çš„åšæ³•**ï¼ˆå‘½ä»¤æ¨¡å¼ï¼‰ï¼š
ä½ ååœ¨åº§ä½ä¸Šï¼Œå¡«ä¸€å¼ ç‚¹èœå•ï¼š

```txt
èœå“ï¼šçº¢çƒ§ç‰›è‚‰é¢
å¤‡æ³¨ï¼šç‰›è‚‰å¤šæ”¾ï¼Œé¢æ¡åç¡¬
æ¡Œå·ï¼š18
```

æœåŠ¡å‘˜æ”¶èµ°èœå•ï¼Œå¤¹åˆ°å¨æˆ¿çš„è®¢å•æ¶ä¸Šã€‚å¨å¸ˆæœ‰ç©ºäº†å°±ç…§ç€å•å­åšï¼Œåšå®Œäº†æœåŠ¡å‘˜ç«¯è¿‡æ¥ã€‚

çœ‹å‡ºåŒºåˆ«æ²¡æœ‰ï¼Ÿ

ç‚¹èœå•ï¼ˆCommandï¼‰æŠŠä½ çš„éœ€æ±‚å˜æˆäº†ä¸€ä¸ª"å¯¹è±¡"ï¼Œå®ƒå¯ä»¥ï¼š

1. 1. **è¢«ä¼ é€’**ï¼šæœåŠ¡å‘˜å¯ä»¥æ‹¿ç€å®ƒèµ°æ¥èµ°å»
2. 2. **è¢«æ’é˜Ÿ**ï¼šå¤šå¼ å•å­å¯ä»¥æŒ‰é¡ºåºæ’åœ¨è®¢å•æ¶ä¸Š
3. 3. **è¢«è®°å½•**ï¼šè€æ¿å¯ä»¥æŸ¥è´¦ï¼Œçœ‹ä»Šå¤©å–äº†å¤šå°‘ç‰›è‚‰é¢
4. 4. **è¢«æ’¤å›**ï¼šä½ åæ‚”äº†å¯ä»¥å«æœåŠ¡å‘˜æŠŠå•å­æ’¤å›æ¥ï¼ˆåœ¨å¨å¸ˆè¿˜æ²¡åšä¹‹å‰ï¼‰

è¿™å°±æ˜¯å‘½ä»¤æ¨¡å¼çš„ç²¾é«“ï¼š**æŠŠ"è¯·æ±‚"å°è£…æˆå¯¹è±¡ï¼Œè®©ä½ å¯ä»¥ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–ã€‚**

### 3.2 å‘½ä»¤æ¨¡å¼çš„æ ¸å¿ƒè§’è‰²

ç¿»è¯‘æˆç¨‹åºä¸–ç•Œï¼Œå‘½ä»¤æ¨¡å¼æœ‰è¿™ä¹ˆå‡ ä¸ªè§’è‰²ï¼š

![img](./assets/å‘½ä»¤æ¨¡å¼çš„æ ¸å¿ƒè§’è‰².png)

ç”¨ä»£ç æ¥è¡¨è¾¾ï¼š

```c
// Commandï¼šå‘½ä»¤ç»“æ„ä½“
typedef struct {
    const char *name;              // å‘½ä»¤åç§°
    void (*execute)(void);         // æ‰§è¡Œå‡½æ•°
} Command_t;

// Receiverï¼šå®é™…å¹²æ´»çš„
void Led_On(void) { /* GPIO æ“ä½œ */ }
void Led_Off(void) { /* GPIO æ“ä½œ */ }

// å®šä¹‰å…·ä½“çš„å‘½ä»¤å®ä¾‹
Command_t cmd_led_on  = { "led_on",  Led_On  };
Command_t cmd_led_off = { "led_off", Led_Off };

// Invokerï¼šæœåŠ¡å‘˜ï¼Œåªç®¡è°ƒç”¨ execute
void Invoker_Execute(Command_t *cmd)
{
    if (cmd && cmd->execute) {
        cmd->execute();
    }
}
```

çœ‹åˆ°äº†å—ï¼Ÿ`Invoker_Execute` å‡½æ•°æ ¹æœ¬ä¸çŸ¥é“å…·ä½“è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Œå®ƒåªçŸ¥é“è°ƒç”¨ `cmd->execute()`ã€‚è¿™å°±æ˜¯**è§£è€¦**çš„å¨åŠ›ã€‚

### 3.3 ç”¨åœ¨æŒ‰é”®ä¸Šæ˜¯ä»€ä¹ˆæ•ˆæœï¼Ÿ

å›åˆ°è€å¼ çš„æ™ºèƒ½é¢æ¿é¡¹ç›®ã€‚ç”¨å‘½ä»¤æ¨¡å¼é‡æ„åï¼Œä»£ç å˜æˆè¿™æ ·ï¼š

```c
// å‘½ä»¤è¡¨ï¼šæŒ‰é”®åˆ°å‘½ä»¤çš„æ˜ å°„
Command_t *key_command_table[4] = {
    &cmd_led_on,      // KEY1 -> å¼€ç¯
    &cmd_led_off,     // KEY2 -> å…³ç¯
    &cmd_fan_toggle,  // KEY3 -> é£æ‰‡åˆ‡æ¢
    &cmd_mode_switch  // KEY4 -> æ¨¡å¼åˆ‡æ¢
};

// ä¸­æ–­å¤„ç†å‡½æ•°ï¼šå¹²å¹²å‡€å‡€
void KEY_IRQHandler(void)
{
    uint8_t key_id = Get_KeyID();

    if (key_id < 4) {
        Invoker_Execute(key_command_table[key_id]);
    }
}
```

ç°åœ¨ä¸­æ–­å‡½æ•°åªå¹²ä¸€ä»¶äº‹ï¼šæŸ¥è¡¨ã€æ‰§è¡Œã€‚å®ƒä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒ KEY1 æŒ‰ä¸‹åå…·ä½“è¦å¹²ä»€ä¹ˆã€‚

å¦‚æœäº§å“ç»ç†è¯´è¦æŠŠ KEY1 æ”¹æˆæ§åˆ¶çª—å¸˜ï¼Œä½ åªéœ€è¦ï¼š

```c
key_command_table[0] = &cmd_curtain_toggle;
```

ä¸€è¡Œä»£ç æå®šï¼Œä¸ç”¨æ”¹ä¸­æ–­å‡½æ•°ï¼Œä¹Ÿä¸ç”¨æ”¹ LED æ¨¡å—çš„ä»£ç ã€‚

æ›´ç‰›çš„æ˜¯ï¼Œå¦‚æœè¦å®ç°"é•¿æŒ‰ KEY1 åŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œ"ï¼Œæˆ‘ä»¬åé¢è¿˜ä¼šè®²**å®å‘½ä»¤**ï¼Œä¹Ÿæ˜¯ä¸€è¡Œä»£ç çš„äº‹ã€‚

### 3.4 ç”¨åœ¨ä¸²å£ä¸Šæ˜¯ä»€ä¹ˆæ•ˆæœï¼Ÿ

ä¸²å£è§£æä¹Ÿå˜å¾—ä¼˜é›…å¤šäº†ï¼š

```c
// å‘½ä»¤æ³¨å†Œè¡¨
Command_t cmd_table[] = {
    { "led_on",    Led_On    },
    { "led_off",   Led_Off   },
    { "motor_run", Motor_Run },
    { "get_temp",  Get_Temp  },
    // ... åŠ æ–°å‘½ä»¤åªéœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä¸€è¡Œ
};

// è§£æå™¨ï¼šéå†è¡¨æŸ¥æ‰¾
void CLI_Execute(const char *input)
{
    for (int i = 0; i < CMD_TABLE_SIZE; i++) {
        if (strcmp(input, cmd_table[i].name) == 0) {
            cmd_table[i].execute();
            return;
        }
    }
    printf("Unknown command: %s\n", input);
}
```

è™½ç„¶è¿˜æ˜¯éå†ï¼Œä½†æœ‰æœ¬è´¨åŒºåˆ«ï¼š

1. 1. **å‘½ä»¤è¡¨å’Œè§£æå™¨åˆ†ç¦»**ã€‚åŠ æ–°å‘½ä»¤åªæ”¹è¡¨ï¼Œä¸æ”¹è§£æé€»è¾‘ã€‚
2. 2. **å¯ä»¥ç©æ›´å¤šèŠ±æ ·**ã€‚æ¯”å¦‚æŒ‰å­—æ¯åºæ’åˆ—å‘½ä»¤ï¼Œç”¨äºŒåˆ†æŸ¥æ‰¾æé€Ÿï¼›æˆ–è€…ç”¨å®Œç¾å“ˆå¸Œï¼Œç›´æ¥ O(1) æŸ¥æ‰¾ã€‚
3. 3. **å®¹æ˜“æ‰©å±•**ã€‚å‘½ä»¤ç»“æ„ä½“å¯ä»¥åŠ æ›´å¤šå­—æ®µï¼Œæ¯”å¦‚å¸®åŠ©ä¿¡æ¯ã€æƒé™ç­‰çº§ç­‰ã€‚

------

## ã€æ€è€ƒé¢˜ã€‘åœ¨ç»§ç»­ä¹‹å‰...

ä½ å¯èƒ½è§‰å¾—æŠŠå‡½æ•°å°è£…æˆç»“æ„ä½“ï¼Œç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œè¿™äº‹ä¹Ÿæ²¡å¤šå¤æ‚å˜›ã€‚

ä½†åˆ«æ€¥ï¼Œæœ‰å‡ ä¸ªé—®é¢˜æƒ³è¯·ä½ å…ˆæƒ³ä¸€æƒ³ï¼š

**é—®é¢˜ä¸€ï¼šå¦‚ä½•åšåˆ°é›¶ RAM æ¶ˆè€—ï¼Ÿ**

ä¸Šé¢çš„å‘½ä»¤è¡¨ `cmd_table[]` æ˜¯ä¸ªæ•°ç»„ï¼Œæ”¾åœ¨ RAM é‡Œã€‚å¦‚æœä½ çš„ MCU åªæœ‰ 8KB RAMï¼Œå‘½ä»¤ä¸€å¤šï¼Œè¿™è¡¨å°±å æ‰ä¸å°‘ç©ºé—´ã€‚æœ‰æ²¡æœ‰åŠæ³•æŠŠå®ƒæ”¾åˆ° Flash é‡Œï¼Ÿ

**é—®é¢˜äºŒï¼šå¸¦å‚æ•°çš„å‘½ä»¤æ€ä¹ˆè§£æï¼Ÿ**

ç®€å•å‘½ä»¤å¦‚ `led_on` è¿˜å¥½ï¼Œä½†å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ï¼š

```c
motor -speed 100 -dir cw
```

ä½ æ€ä¹ˆæŠŠ `-speed 100` å’Œ `-dir cw` æå–å‡ºæ¥ï¼Ÿç”¨ `strtok`ï¼Ÿé‚£å‡½æ•°åœ¨åµŒå…¥å¼ç¯å¢ƒä¸‹æœ‰å‘ï¼Œä½ çŸ¥é“å—ï¼Ÿ

**é—®é¢˜ä¸‰ï¼šå¦‚ä½•å®ç°"å®å‘½ä»¤"ï¼Ÿ**

ç”¨æˆ·æƒ³è¦"ä¸€é”®å›å®¶æ¨¡å¼"ï¼šå¼€ç¯ã€å¼€ç©ºè°ƒã€å…³çª—å¸˜ã€æ’­æ”¾éŸ³ä¹â€”â€”å››ä¸ªæ“ä½œä¸€èµ·æ‰§è¡Œã€‚æ€ä¹ˆå®ç°è¿™ç§å‘½ä»¤ç»„åˆï¼Ÿè¿˜è¦æ”¯æŒç”¨æˆ·è‡ªå·±"å½•åˆ¶"æ“ä½œåºåˆ—ï¼Ÿ

**é—®é¢˜å››ï¼šä¸­æ–­é‡Œèƒ½ç›´æ¥æ‰§è¡Œå‘½ä»¤å—ï¼Ÿ**

å¦‚æœåœ¨ä¸²å£ä¸­æ–­é‡Œç›´æ¥è°ƒç”¨å‘½ä»¤å¤„ç†å‡½æ•°ï¼Œä¸‡ä¸€æŸä¸ªå‘½ä»¤æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼ˆæ¯”å¦‚å†™ Flashï¼‰ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç³»ç»Ÿä¼šå¡æ­»å—ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ

------

> **ã€è¯•è¯»ç»“æŸã€‘**
>
> ä»¥ä¸Šæ˜¯æœ¬æ–‡çš„å…è´¹è¯•è¯»éƒ¨åˆ†ã€‚
>
> æ¥ä¸‹æ¥çš„ä»˜è´¹å†…å®¹ï¼Œæˆ‘å°†æ‰‹æŠŠæ‰‹å¸¦ä½ å®ç°ä¸¤ä¸ªæ¨¡å—ï¼š
>
> ğŸ“¦ **æç®€ CLI å¼•æ“**
>
> - â€¢ ç±»ä¼¼ Linux Shell çš„äº¤äº’ä½“éªŒ
> - â€¢ å‚æ•°è‡ªåŠ¨è§£æï¼ˆæ”¯æŒ `-key value` æ ¼å¼ï¼‰
> - â€¢ å‘½ä»¤è¡¨å­˜ Flashï¼Œé›¶ RAM æ¶ˆè€—
> - â€¢ ç”¨é“¾æ¥å™¨é­”æ³•å®ç°"åˆ†æ•£å®šä¹‰ï¼Œè‡ªåŠ¨æ±‡èš"
>
> ğŸ“¦ **å‘½ä»¤é˜Ÿåˆ—ç³»ç»Ÿ**
>
> - â€¢ ä¸­æ–­é‡Œåªæ”¶æ•°æ®ï¼Œä¸»å¾ªç¯å¤„ç†å‘½ä»¤
> - â€¢ å½»åº•è§£å†³"ä¸­æ–­å¡æ­»"é—®é¢˜
> - â€¢ æ”¯æŒå®å‘½ä»¤å½•åˆ¶ä¸å›æ”¾

------

## å››ã€æ·±å…¥å®æˆ˜ï¼šæ‰“é€ ä¸€ä¸ªçœŸæ­£èƒ½ç”¨çš„åµŒå…¥å¼ CLI

ä¸Šé¢çš„ä¾‹å­åªæ˜¯å¼€èƒƒèœã€‚çœŸå®é¡¹ç›®ä¸­ï¼Œä½ ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼š

- â€¢ å¸¦å‚æ•°çš„å‘½ä»¤æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ `motor -speed 100 -dir cw`
- â€¢ å‘½ä»¤è¡¨èƒ½ä¸èƒ½å­˜åœ¨ Flash é‡Œï¼Œä¸å ç”¨å®è´µçš„ RAMï¼Ÿ
- â€¢ æ€ä¹ˆå®ç°è‡ªåŠ¨è¡¥å…¨å’Œå¸®åŠ©ä¿¡æ¯ï¼Ÿ
- â€¢ å¦‚ä½•è®©å„ä¸ªæ¨¡å—è‡ªå·±æ³¨å†Œå‘½ä»¤ï¼Œè€Œä¸æ˜¯é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€æ­¥æ­¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæ‰‹æ’¸ä¸€ä¸ªç”Ÿäº§çº§çš„ CLI æ¨¡å—ã€‚

### 4.1 å‡çº§å‘½ä»¤ç»“æ„ä½“

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¼ºå¤§çš„å‘½ä»¤ç»“æ„ä½“ï¼š

```c
/**
 * @brief CLI å‘½ä»¤ç»“æ„ä½“
 * @note  æ•´ä¸ªç»“æ„ä½“ä½¿ç”¨ const ä¿®é¥°ï¼Œå­˜æ”¾åœ¨ Flash ä¸­
 */
typedef struct {
    const char *cmd_name;      // å‘½ä»¤åç§°ï¼Œå¦‚ "led"
    const char *help_info;     // å¸®åŠ©ä¿¡æ¯ï¼Œå¦‚ "Control LED on/off"
    const char *usage;         // ä½¿ç”¨ç¤ºä¾‹ï¼Œå¦‚ "led <on|off>"
    uint8_t     permission;    // æƒé™ç­‰çº§ï¼š0=ç”¨æˆ·ï¼Œ1=å·¥ç¨‹å¸ˆï¼Œ2=å·¥å‚
    /**
     * @brief å‘½ä»¤å¤„ç†å‡½æ•°
     * @param argc å‚æ•°ä¸ªæ•°ï¼ˆç±»ä¼¼ main å‡½æ•°çš„ argcï¼‰
     * @param argv å‚æ•°æ•°ç»„ï¼ˆç±»ä¼¼ main å‡½æ•°çš„ argvï¼‰
     * @retval 0 æˆåŠŸï¼Œå…¶ä»–å€¼è¡¨ç¤ºé”™è¯¯ç 
     */
    int (*handler)(int argc, char *argv[]);
} CLI_Command_t;
```

å‡ ä¸ªè®¾è®¡è¦ç‚¹ï¼š

1. 1. **`argc/argv` é£æ ¼**ï¼šå’Œ C è¯­è¨€çš„ `main` å‡½æ•°ä¿æŒä¸€è‡´ï¼Œé™ä½å­¦ä¹ æˆæœ¬ã€‚`argv[0]` æ˜¯å‘½ä»¤æœ¬èº«ï¼Œ`argv[1]` å¼€å§‹æ˜¯å‚æ•°ã€‚
2. 2. **`permission` å­—æ®µ**ï¼šé˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œã€‚æ¯”å¦‚ `factory_reset` è¿™ç§å±é™©å‘½ä»¤ï¼Œåªæœ‰åœ¨å·¥å‚æ¨¡å¼ä¸‹æ‰èƒ½æ‰§è¡Œã€‚
3. 3. **è¿”å›å€¼**ï¼šè¿”å› 0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 è¡¨ç¤ºé”™è¯¯ã€‚è¿™æ ·è°ƒç”¨è€…å¯ä»¥æ ¹æ®è¿”å›å€¼åšè¿›ä¸€æ­¥å¤„ç†ã€‚

### 4.2 ç”¨é“¾æ¥å™¨é­”æ³•å®ç°å‘½ä»¤è‡ªåŠ¨æ³¨å†Œ

è¿™æ˜¯æ•´ä¸ª CLI æ¨¡å—æœ€ç²¾é«“çš„éƒ¨åˆ†ã€‚

ä¼ ç»Ÿåšæ³•æ˜¯åœ¨æŸä¸ª .c æ–‡ä»¶é‡Œå®šä¹‰ä¸€ä¸ªå·¨å¤§çš„å‘½ä»¤è¡¨æ•°ç»„ï¼Œæ¯æ¬¡åŠ å‘½ä»¤å°±å»æ”¹è¿™ä¸ªæ–‡ä»¶ã€‚è¿™æ ·åšçš„ç¼ºç‚¹å‰é¢è¯´è¿‡äº†ï¼šè¿åå¼€é—­åŸåˆ™ï¼Œå¤šäººåä½œå®¹æ˜“å†²çªã€‚

æ›´ä¼˜é›…çš„åšæ³•æ˜¯ï¼š**è®©æ¯ä¸ªæ¨¡å—è‡ªå·±æ³¨å†Œè‡ªå·±çš„å‘½ä»¤ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨æŠŠå®ƒä»¬æ±‡èšåˆ°ä¸€èµ·ã€‚**

è¿™éœ€è¦ç”¨åˆ° GCC çš„ `__attribute__((section))` ç‰¹æ€§ï¼Œæˆ‘åœ¨ä¸Šä¸€ç¯‡è®²å‘å¸ƒ-è®¢é˜…çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿‡ã€‚

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªä¸“ç”¨çš„å†…å­˜æ®µï¼š

```c
// åœ¨é“¾æ¥è„šæœ¬ .ld æ–‡ä»¶ä¸­æ·»åŠ 
.cli_cmd_section : {
    . = ALIGN(4);
    __cli_cmd_start = .;
    KEEP(*(.cli_cmd_section))
    __cli_cmd_end = .;
} > FLASH
```

ç„¶åï¼Œå®šä¹‰ä¸€ä¸ªæ³¨å†Œå®ï¼š

```c
// cli.h
#define CLI_EXPORT_CMD(name, handler, help, usage, perm)          \
    __attribute__((used, section(".cli_cmd_section")))            \
    static const CLI_Command_t __cli_cmd_##name = {               \
        .cmd_name   = #name,                                      \
        .handler    = handler,                                    \
        .help_info  = help,                                       \
        .usage      = usage,                                      \
        .permission = perm                                        \
    }
```

ä½¿ç”¨èµ·æ¥è¶…çº§ç®€å•ã€‚åœ¨ä»»æ„ .c æ–‡ä»¶ä¸­ï¼š

```c
// led.c

static int cmd_led(int argc, char *argv[])
{
    if (argc < 2) {
        printf("Usage: led <on|off>\n");
        return -1;
    }

    if (strcmp(argv[1], "on") == 0) {
        Led_On();
        printf("LED is ON\n");
    } else if (strcmp(argv[1], "off") == 0) {
        Led_Off();
        printf("LED is OFF\n");
    } else {
        printf("Unknown option: %s\n", argv[1]);
        return -1;
    }
    return 0;
}

// ä¸€è¡Œå®ï¼Œè‡ªåŠ¨æ³¨å†Œï¼
CLI_EXPORT_CMD(led, cmd_led, "Control LED", "led <on|off>", 0);
// motor.c

static int cmd_motor(int argc, char *argv[])
{
    int speed = 50;  // é»˜è®¤é€Ÿåº¦
    int dir = 1;     // é»˜è®¤æ­£è½¬

    for (int i = 1; i < argc; i++) {
        if (strcmp(argv[i], "-speed") == 0 && i + 1 < argc) {
            speed = atoi(argv[++i]);
        } else if (strcmp(argv[i], "-dir") == 0 && i + 1 < argc) {
            dir = (strcmp(argv[++i], "cw") == 0) ? 1 : 0;
        }
    }

    Motor_Run(speed, dir);
    printf("Motor running: speed=%d, dir=%s\n", speed, dir ? "CW" : "CCW");
    return 0;
}

CLI_EXPORT_CMD(motor, cmd_motor, "Control motor", "motor [-speed N] [-dir cw|ccw]", 1);
```

ç¼–è¯‘å®Œæˆåï¼Œæ‰€æœ‰ç”¨ `CLI_EXPORT_CMD` æ³¨å†Œçš„å‘½ä»¤éƒ½ä¼šè‡ªåŠ¨æ±‡èšåˆ° `.cli_cmd_section` æ®µä¸­ã€‚CLI å¼•æ“é€šè¿‡ `__cli_cmd_start` å’Œ `__cli_cmd_end` ä¸¤ä¸ªç¬¦å·å°±èƒ½éå†æ‰€æœ‰å‘½ä»¤ã€‚

```c
// cli.c

extern const CLI_Command_t __cli_cmd_start;
extern const CLI_Command_t __cli_cmd_end;

const CLI_Command_t *CLI_FindCommand(const char *name)
{
    const CLI_Command_t *cmd = &__cli_cmd_start;

    while (cmd < &__cli_cmd_end) {
        if (strcmp(cmd->cmd_name, name) == 0) {
            return cmd;
        }
        cmd++;
    }
    return NULL;  // æœªæ‰¾åˆ°
}
```

è¿™ç§åšæ³•çš„å¥½å¤„ï¼š

1. 1. **é›¶ä¿®æ”¹æ‰©å±•**ï¼šåŠ æ–°å‘½ä»¤åªéœ€è¦åœ¨å¯¹åº”æ¨¡å—é‡ŒåŠ ä¸€è¡Œ `CLI_EXPORT_CMD`ï¼Œå®Œå…¨ä¸ç”¨æ”¹ CLI æ ¸å¿ƒä»£ç ã€‚
2. 2. **å‘½ä»¤å°±è¿‘å®šä¹‰**ï¼šLED å‘½ä»¤å°±å†™åœ¨ led.c é‡Œï¼Œç”µæœºå‘½ä»¤å°±å†™åœ¨ motor.c é‡Œï¼ŒèŒè´£æ¸…æ™°ã€‚
3. 3. **é›¶ RAM æ¶ˆè€—**ï¼šæ•´ä¸ªå‘½ä»¤è¡¨éƒ½å­˜åœ¨ Flash ä¸­ï¼Œä¸å ç”¨ä¸€å­—èŠ‚ RAMã€‚

### 4.3 å‚æ•°è§£æå™¨ï¼šæŠŠå­—ç¬¦ä¸²å˜æˆ argc/argv

ç”¨æˆ·è¾“å…¥çš„æ˜¯ä¸€ä¸²å­—ç¬¦ `"motor -speed 100 -dir cw"`ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒåˆ‡æˆ `argc=5, argv={"motor", "-speed", "100", "-dir", "cw"}`ã€‚

æ ‡å‡†åº“é‡Œæœ‰ä¸ª `strtok` å‡½æ•°å¯ä»¥åšè¿™ä»¶äº‹ï¼Œä½†å®ƒæœ‰ä¸¤ä¸ªè‡´å‘½ç¼ºç‚¹ï¼š

1. 1. **çº¿ç¨‹ä¸å®‰å…¨**ï¼šå†…éƒ¨ç”¨äº†é™æ€å˜é‡è®°å½•åˆ‡å‰²ä½ç½®ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¼šå‡ºé—®é¢˜ã€‚
2. 2. **ç ´ååŸå­—ç¬¦ä¸²**ï¼šä¼šæŠŠç©ºæ ¼æ›¿æ¢æˆ `\0`ï¼Œå¯¼è‡´åŸå­—ç¬¦ä¸²è¢«æ”¹å¾—é¢ç›®å…¨éã€‚

åœ¨åµŒå…¥å¼ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªç®€æ´ç‰ˆçš„åˆ†è¯å™¨ï¼š

```c
#define CLI_MAX_ARGS    10      // æœ€å¤§å‚æ•°ä¸ªæ•°
#define CLI_LINE_SIZE   128     // å‘½ä»¤è¡Œæœ€å¤§é•¿åº¦

typedef struct {
    int   argc;
    char *argv[CLI_MAX_ARGS];
    char  line_buf[CLI_LINE_SIZE];  // å†…éƒ¨ç¼“å†²åŒºï¼Œå­˜æ”¾åˆ‡å‰²åçš„å­—ç¬¦ä¸²
} CLI_Args_t;

/**
 * @brief è§£æå‘½ä»¤è¡Œå­—ç¬¦ä¸²
 * @param input  è¾“å…¥å­—ç¬¦ä¸²ï¼ˆä¸ä¼šè¢«ä¿®æ”¹ï¼‰
 * @param args   è¾“å‡ºç»“æœ
 * @retval å‚æ•°ä¸ªæ•°
 */
int CLI_Parse(const char *input, CLI_Args_t *args)
{
    // å¤åˆ¶åˆ°å†…éƒ¨ç¼“å†²åŒºï¼ˆé¿å…ç ´ååŸå­—ç¬¦ä¸²ï¼‰
    strncpy(args->line_buf, input, CLI_LINE_SIZE - 1);
    args->line_buf[CLI_LINE_SIZE - 1] = '\0';

    args->argc = 0;
    char *p = args->line_buf;
    bool in_quote = false;

    while (*p && args->argc < CLI_MAX_ARGS) {
        // è·³è¿‡å‰å¯¼ç©ºæ ¼
        while (*p == ' ' || *p == '\t') p++;
        if (*p == '\0') break;

        // å¤„ç†å¼•å·åŒ…å›´çš„å‚æ•°ï¼ˆæ”¯æŒå¸¦ç©ºæ ¼çš„å­—ç¬¦ä¸²ï¼‰
        if (*p == '"') {
            in_quote = true;
            p++;  // è·³è¿‡å¼€å¤´çš„å¼•å·
            args->argv[args->argc++] = p;
            while (*p && *p != '"') p++;
            if (*p == '"') *p++ = '\0';
        } else {
            args->argv[args->argc++] = p;
            while (*p && *p != ' ' && *p != '\t') p++;
            if (*p) *p++ = '\0';
        }
    }

    return args->argc;
}
```

è¿™ä¸ªè§£æå™¨æœ‰å‡ ä¸ªäº®ç‚¹ï¼š

1. 1. **æ”¯æŒå¼•å·**ï¼š`echo "Hello World"` ä¼šæŠŠ `Hello World` ä½œä¸ºä¸€ä¸ªå®Œæ•´å‚æ•°ã€‚
2. 2. **ä¸ä½¿ç”¨å †**ï¼šæ‰€æœ‰æ•°æ®éƒ½åœ¨æ ˆä¸Šæˆ–é™æ€åˆ†é…ï¼ŒåµŒå…¥å¼å‹å¥½ã€‚
3. 3. **è¾¹ç•Œä¿æŠ¤**ï¼šæœ€å¤šè§£æ `CLI_MAX_ARGS` ä¸ªå‚æ•°ï¼Œé˜²æ­¢æº¢å‡ºã€‚

### 4.4 å®Œæ•´çš„ CLI å¼•æ“

æŠŠå‰é¢çš„æ¨¡å—ç»„è£…èµ·æ¥ï¼Œå½¢æˆå®Œæ•´çš„ CLI å¼•æ“ï¼š

```c
// cli.c

static uint8_t current_permission_level = 0;  // å½“å‰æƒé™ç­‰çº§

void CLI_SetPermission(uint8_t level)
{
    current_permission_level = level;
}

int CLI_Process(const char *input)
{
    if (input == NULL || input[0] == '\0') {
        return 0;
    }

    // è§£æå‚æ•°
    CLI_Args_t args;
    int argc = CLI_Parse(input, &args);

    if (argc == 0) {
        return 0;
    }

    // æŸ¥æ‰¾å‘½ä»¤
    const CLI_Command_t *cmd = CLI_FindCommand(args.argv[0]);

    if (cmd == NULL) {
        printf("Unknown command: %s\n", args.argv[0]);
        printf("Type 'help' for available commands.\n");
        return -1;
    }

    // æƒé™æ£€æŸ¥
    if (cmd->permission > current_permission_level) {
        printf("Permission denied. Required level: %d, current: %d\n",
               cmd->permission, current_permission_level);
        return -2;
    }

    // æ‰§è¡Œå‘½ä»¤
    return cmd->handler(argc, args.argv);
}

// å†…å»ºå‘½ä»¤ï¼šhelp
static int cmd_help(int argc, char *argv[])
{
    const CLI_Command_t *cmd = &__cli_cmd_start;

    printf("\n=== Available Commands ===\n\n");

    while (cmd < &__cli_cmd_end) {
        // åªæ˜¾ç¤ºæœ‰æƒé™çš„å‘½ä»¤
        if (cmd->permission <= current_permission_level) {
            printf("  %-12s - %s\n", cmd->cmd_name, cmd->help_info);
            if (cmd->usage) {
                printf("               Usage: %s\n", cmd->usage);
            }
        }
        cmd++;
    }

    printf("\n");
    return 0;
}

CLI_EXPORT_CMD(help, cmd_help, "Show this help", "help", 0);
```

ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„åµŒå…¥å¼ CLIï¼š

- â€¢ æ”¯æŒå¸¦å‚æ•°çš„å‘½ä»¤
- â€¢ æ”¯æŒæƒé™ç®¡ç†
- â€¢ æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯
- â€¢ å‘½ä»¤åˆ†æ•£å®šä¹‰ï¼Œç¼–è¯‘æœŸè‡ªåŠ¨æ±‡èš

------

## äº”ã€è¿›é˜¶ç©æ³•ï¼šå‘½ä»¤é˜Ÿåˆ—ä¸å»¶è¿Ÿæ‰§è¡Œ

å‰é¢çš„ CLI å¼•æ“æœ‰ä¸ªæ½œåœ¨é—®é¢˜ï¼šå¦‚æœåœ¨ä¸²å£ä¸­æ–­é‡Œç›´æ¥è°ƒç”¨ `CLI_Process()`ï¼Œè€ŒæŸäº›å‘½ä»¤æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼ˆæ¯”å¦‚å†™ Flashã€å‘é€å¤§é‡æ•°æ®ï¼‰ï¼Œå°±ä¼šå¯¼è‡´ä¸­æ–­è¢«é•¿æ—¶é—´å ç”¨ï¼Œå…¶ä»–ä¸­æ–­å¾—ä¸åˆ°å“åº”ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯**å‘½ä»¤é˜Ÿåˆ—**ï¼šä¸­æ–­é‡Œåªè´Ÿè´£æ¥æ”¶æ•°æ®ï¼ŒæŠŠå®Œæ•´çš„å‘½ä»¤è¡Œ"æŠ•é€’"åˆ°é˜Ÿåˆ—é‡Œï¼Œä¸»å¾ªç¯å†æ…¢æ…¢å¤„ç†ã€‚

### 5.1 ç¯å½¢ç¼“å†²åŒºæ¥æ”¶æ•°æ®

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºæ¥æ¥æ”¶ä¸²å£æ•°æ®ï¼š

```c
#define RX_BUF_SIZE  256

typedef struct {
    char     buf[RX_BUF_SIZE];
    uint16_t head;
    uint16_t tail;
} RingBuffer_t;

static RingBuffer_t rx_ring = {0};

// ä¸­æ–­é‡Œè°ƒç”¨ï¼šå†™å…¥ä¸€ä¸ªå­—ç¬¦
void RingBuffer_Put(char c)
{
    uint16_t next = (rx_ring.head + 1) % RX_BUF_SIZE;
    if (next != rx_ring.tail) {  // ç¼“å†²åŒºæœªæ»¡
        rx_ring.buf[rx_ring.head] = c;
        rx_ring.head = next;
    }
}

// ä¸»å¾ªç¯è°ƒç”¨ï¼šè¯»å–ä¸€ä¸ªå­—ç¬¦
int RingBuffer_Get(char *c)
{
    if (rx_ring.head == rx_ring.tail) {
        return 0;  // ç¼“å†²åŒºä¸ºç©º
    }
    *c = rx_ring.buf[rx_ring.tail];
    rx_ring.tail = (rx_ring.tail + 1) % RX_BUF_SIZE;
    return 1;
}
```

### 5.2 è¡Œæ”¶é›†å™¨

æ¥ä¸‹æ¥ï¼Œä¸»å¾ªç¯ä»ç¯å½¢ç¼“å†²åŒºè¯»å–å­—ç¬¦ï¼Œæ‹¼æˆå®Œæ•´çš„ä¸€è¡Œåå†å¤„ç†ï¼š

```c
static char line_buf[CLI_LINE_SIZE];
static uint8_t line_pos = 0;

void CLI_Poll(void)
{
    char c;

    while (RingBuffer_Get(&c)) {
        if (c == '\r' || c == '\n') {
            if (line_pos > 0) {
                line_buf[line_pos] = '\0';
                CLI_Process(line_buf);  // å¤„ç†å®Œæ•´å‘½ä»¤è¡Œ
                line_pos = 0;
            }
        } else if (c == '\b' || c == 0x7F) {
            // é€€æ ¼å¤„ç†
            if (line_pos > 0) {
                line_pos--;
                printf("\b \b");  // å›æ˜¾åˆ é™¤
            }
        } else if (line_pos < CLI_LINE_SIZE - 1) {
            line_buf[line_pos++] = c;
            putchar(c);  // å›æ˜¾
        }
    }
}
```

ä¸»å¾ªç¯åªéœ€è¦å‘¨æœŸæ€§è°ƒç”¨ `CLI_Poll()` å³å¯ï¼š

```c
int main(void)
{
    System_Init();

    while (1) {
        CLI_Poll();        // å¤„ç†å‘½ä»¤è¡Œ
        OtherTask_Run();   // å…¶ä»–ä»»åŠ¡
    }
}
```

è¿™æ ·ä¸€æ¥ï¼Œä¸²å£ä¸­æ–­å˜å¾—æå…¶ç®€å•ï¼š

```c
void USART1_IRQHandler(void)
{
    if (USART_GetFlagStatus(USART1, USART_FLAG_RXNE)) {
        char c = USART_ReceiveData(USART1);
        RingBuffer_Put(c);  // æ‰”è¿›ç¼“å†²åŒºå°±å®Œäº‹
    }
}
```

ä¸­æ–­å¤„ç†æ—¶é—´çŸ­åˆ°å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå½»åº•è§£å†³äº†ä¸­æ–­å¡æ­»é—®é¢˜ã€‚

### 5.3 å®å‘½ä»¤ï¼šä¸€é”®æ‰§è¡Œå¤šä¸ªæ“ä½œ

å‘½ä»¤æ¨¡å¼è¿˜æœ‰ä¸ªæ€æ‰‹çº§åŠŸèƒ½ï¼š**å®å‘½ä»¤ï¼ˆMacro Commandï¼‰**ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œç”¨æˆ·æƒ³è¦"ä¸€é”®å›å®¶æ¨¡å¼"ï¼šå¼€ç¯ã€å¼€ç©ºè°ƒã€å…³çª—å¸˜ã€æ’­æ”¾éŸ³ä¹ã€‚å¦‚æœæ¯æ¬¡éƒ½è¦è¾“å…¥å››æ¡å‘½ä»¤ï¼Œå¤ªéº»çƒ¦äº†ã€‚

å®å‘½ä»¤å°±æ˜¯æŠŠå¤šä¸ªå‘½ä»¤æ‰“åŒ…æˆä¸€ä¸ªï¼Œæ‰§è¡Œå®å°±æ˜¯ä¾æ¬¡æ‰§è¡Œé‡Œé¢çš„æ¯ä¸ªå‘½ä»¤ï¼š

```c
#define MACRO_MAX_CMDS  8

typedef struct {
    const char *name;
    const char *cmd_list[MACRO_MAX_CMDS];
    uint8_t     cmd_count;
} Macro_t;

// é¢„å®šä¹‰çš„å®
static Macro_t macros[] = {
    {
        .name = "home",
        .cmd_list = {"led on", "aircon on", "curtain close", "music play"},
        .cmd_count = 4
    },
    {
        .name = "leave",
        .cmd_list = {"led off", "aircon off", "curtain open", "music stop"},
        .cmd_count = 4
    }
};

// æ‰§è¡Œå®
int Macro_Run(const char *name)
{
    for (int i = 0; i < sizeof(macros)/sizeof(macros[0]); i++) {
        if (strcmp(macros[i].name, name) == 0) {
            printf("Running macro: %s\n", name);
            for (int j = 0; j < macros[i].cmd_count; j++) {
                printf("> %s\n", macros[i].cmd_list[j]);
                CLI_Process(macros[i].cmd_list[j]);
            }
            return 0;
        }
    }
    printf("Macro not found: %s\n", name);
    return -1;
}

// æ³¨å†Œ macro å‘½ä»¤
static int cmd_macro(int argc, char *argv[])
{
    if (argc < 2) {
        printf("Usage: macro <name>\n");
        printf("Available macros: home, leave\n");
        return -1;
    }
    return Macro_Run(argv[1]);
}

CLI_EXPORT_CMD(macro, cmd_macro, "Run a macro", "macro <home|leave>", 0);
```

ç”¨æˆ·åªéœ€è¾“å…¥ `macro home`ï¼Œå°±èƒ½è‡ªåŠ¨æ‰§è¡Œå››æ¡å‘½ä»¤ã€‚

æ›´è¿›ä¸€æ­¥ï¼Œä½ è¿˜å¯ä»¥å®ç°**å®å½•åˆ¶**åŠŸèƒ½ï¼šç”¨æˆ·è¾“å…¥ `record start`ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ï¼Œæœ€å `record stop`ï¼Œè¿™äº›å‘½ä»¤å°±è¢«è®°å½•ä¸‹æ¥ï¼Œä»¥åå¯ä»¥ä¸€é”®å›æ”¾ã€‚è¿™åœ¨å·¥ä¸šè‡ªåŠ¨åŒ–çš„"ç¤ºæ•™æ¨¡å¼"é‡Œéå¸¸å¸¸è§ã€‚

------

## å…­ã€é¿å‘æŒ‡å—ï¼šè€é¸Ÿçš„ç»éªŒä¹‹è°ˆ

å†™ CLI è¿™ä¹ˆå¤šå¹´ï¼Œè¸©è¿‡çš„å‘ä¹Ÿä¸å°‘ã€‚è¿™é‡Œåˆ†äº«å‡ æ¡è¡€æ³ªç»éªŒã€‚

### å‘ä¸€ï¼šæ ˆæº¢å‡º

å‘½ä»¤è¡Œå‚æ•° `argv` æ•°ç»„é€šå¸¸æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ã€‚å¦‚æœå‚æ•°ç‰¹åˆ«å¤šï¼Œæˆ–è€…å•ä¸ªå‚æ•°å­—ç¬¦ä¸²ç‰¹åˆ«é•¿ï¼Œå¾ˆå®¹æ˜“æŠŠæ ˆæ’‘çˆ†ã€‚

ç—‡çŠ¶ï¼šç¨‹åºè«åå…¶å¦™è·‘é£ï¼ŒHard Faultï¼Œæˆ–è€…å±€éƒ¨å˜é‡çš„å€¼è«åè¢«æ”¹ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. 1. **é™åˆ¶å‚æ•°ä¸ªæ•°**ï¼š`CLI_MAX_ARGS` ä¸è¦è®¾å¤ªå¤§ï¼Œ10 ä¸ªè¶³å¤Ÿåº”ä»˜å¤§å¤šæ•°åœºæ™¯ã€‚
2. 2. **é™åˆ¶è¡Œé•¿åº¦**ï¼š`CLI_LINE_SIZE` è®¾ä¸ªåˆç†å€¼ï¼Œ128 æˆ– 256 å­—èŠ‚ã€‚
3. 3. **å¢å¤§æ ˆç©ºé—´**ï¼šåœ¨å¯åŠ¨æ–‡ä»¶æˆ–é“¾æ¥è„šæœ¬é‡ŒæŠŠæ ˆè°ƒå¤§ä¸€äº›ã€‚

```c
// å¯åŠ¨æ–‡ä»¶ä¸­
Stack_Size      EQU     0x00001000   // 4KB æ ˆç©ºé—´
```

### å‘äºŒï¼šæƒé™ç®¡ç†æ¼æ´

å¦‚æœä½ çš„è®¾å¤‡è¦äº¤ç»™å®¢æˆ·ä½¿ç”¨ï¼Œä¸€å®šè¦åšå¥½æƒé™ç®¡ç†ã€‚æœ‰äº›å‘½ä»¤ï¼ˆæ¯”å¦‚ `factory_reset`ã€`flash_erase`ï¼‰ä¸èƒ½è®©æ™®é€šç”¨æˆ·éšä¾¿æ‰§è¡Œã€‚

å‰é¢æˆ‘ä»¬åœ¨å‘½ä»¤ç»“æ„ä½“é‡ŒåŠ äº† `permission` å­—æ®µï¼Œä½†è¿™åªæ˜¯ç¬¬ä¸€æ­¥ã€‚ä½ è¿˜éœ€è¦ï¼š

1. 1. **è¿›å…¥å·¥å‚æ¨¡å¼è¦æœ‰é—¨æ§›**ï¼šæ¯”å¦‚éœ€è¦è¾“å…¥å¯†ç ï¼Œæˆ–è€…éœ€è¦ç‰¹å®šçš„ç¡¬ä»¶æ“ä½œï¼ˆé•¿æŒ‰æŸä¸ªæŒ‰é”® 10 ç§’ï¼‰ã€‚
2. 2. **æ•æ„Ÿæ“ä½œè¦äºŒæ¬¡ç¡®è®¤**ï¼šæ‰§è¡Œ `factory_reset` ä¹‹å‰ï¼Œæç¤ºç”¨æˆ·è¾“å…¥ `YES` ç¡®è®¤ã€‚
3. 3. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•è°åœ¨ä»€ä¹ˆæ—¶é—´æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤ï¼Œæ–¹ä¾¿äº‹åè¿½æº¯ã€‚

```c
static int cmd_factory_reset(int argc, char *argv[])
{
    printf("WARNING: This will erase all user data!\n");
    printf("Type 'YES' to confirm: ");

    // ç­‰å¾…ç”¨æˆ·è¾“å…¥ç¡®è®¤
    char confirm[8];
    if (gets_s(confirm, sizeof(confirm)) && strcmp(confirm, "YES") == 0) {
        printf("Resetting...\n");
        Factory_Reset();
        return 0;
    }

    printf("Cancelled.\n");
    return -1;
}
```

### å‘ä¸‰ï¼šå‘½ä»¤åå†²çª

ç”¨äº† `__attribute__((section))` è‡ªåŠ¨æ³¨å†Œåï¼Œæ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ç‹¬ç«‹å®šä¹‰å‘½ä»¤ã€‚ä½†å¦‚æœä¸¤ä¸ªæ¨¡å—éƒ½å®šä¹‰äº†åŒåå‘½ä»¤ï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. 1. **å‘½åçº¦å®š**ï¼šå‘½ä»¤åå¸¦æ¨¡å—å‰ç¼€ï¼Œæ¯”å¦‚ `led_on`ã€`motor_run`ã€‚
2. 2. **ç¼–è¯‘æœŸæ£€æŸ¥**ï¼šå†™ä¸ªè„šæœ¬æ‰«ææ‰€æœ‰ `.c` æ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ `CLI_EXPORT_CMD`ã€‚
3. 3. **è¿è¡Œæ—¶æ£€æŸ¥**ï¼šåœ¨ `CLI_Init()` é‡Œéå†å‘½ä»¤è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡åã€‚

### å‘å››ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒæ•ˆç‡

å¦‚æœå‘½ä»¤ç‰¹åˆ«å¤šï¼ˆå‡ åä¸Šç™¾ä¸ªï¼‰ï¼Œçº¿æ€§éå†æŸ¥æ‰¾ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

å‡ ç§ä¼˜åŒ–æ€è·¯ï¼š

1. 1. **æŒ‰å­—æ¯åºæ’åˆ— + äºŒåˆ†æŸ¥æ‰¾**ï¼šæŠŠå‘½ä»¤è¡¨æŒ‰åç§°æ’åºï¼ŒæŸ¥æ‰¾å¤æ‚åº¦ä» O(N) é™åˆ° O(logN)ã€‚
2. 2. **å®Œç¾å“ˆå¸Œ**ï¼šå¦‚æœå‘½ä»¤é›†åˆæ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç”¨ gperf å·¥å…·ç”Ÿæˆå®Œç¾å“ˆå¸Œå‡½æ•°ï¼ŒO(1) æŸ¥æ‰¾ã€‚
3. 3. **é¦–å­—æ¯åˆ†æ¡¶**ï¼šæŒ‰å‘½ä»¤é¦–å­—æ¯åˆ†æˆ 26 ä¸ªæ¡¶ï¼Œå…ˆå®šä½æ¡¶å†çº¿æ€§æŸ¥æ‰¾ï¼Œç®€å•æœ‰æ•ˆã€‚

å¯¹äºå¤§å¤šæ•°åµŒå…¥å¼é¡¹ç›®ï¼Œå‘½ä»¤æ•°é‡ä¸ä¼šå¤ªå¤šï¼Œçº¿æ€§æŸ¥æ‰¾è¶³å¤Ÿç”¨ã€‚è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºã€‚

------

## ä¸ƒã€æ€»ç»“

å†™åˆ°è¿™é‡Œï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å‘½ä»¤æ¨¡å¼å¸¦æ¥çš„æ”¹å˜ï¼š

![img](./assets/640-1771727166868-1.png)

å‘½ä»¤æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**æŠŠ"è¯·æ±‚"å°è£…æˆå¯¹è±¡**ã€‚

è¿™ä¸ªæ€æƒ³çœ‹ä¼¼ç®€å•ï¼Œä½†å¨åŠ›å·¨å¤§ã€‚å®ƒè®©ä½ çš„ä»£ç ä»"è¿‡ç¨‹å¼"å‡çº§ä¸º"æ•°æ®é©±åŠ¨å¼"ã€‚ä½ ä¸å†æ˜¯åœ¨ä»£ç é‡Œç¡¬ç¼–ç "å…ˆåšè¿™ä¸ªã€å†åšé‚£ä¸ª"ï¼Œè€Œæ˜¯å®šä¹‰ä¸€å¥—æ•°æ®ç»“æ„æ¥æè¿°è¦åšä»€ä¹ˆï¼Œç„¶åç”¨ç»Ÿä¸€çš„å¼•æ“å»æ‰§è¡Œã€‚

è¿™ç§æ€ç»´æ–¹å¼çš„è½¬å˜ï¼Œæ˜¯ä»"ç å†œ"åˆ°"æ¶æ„å¸ˆ"çš„å…³é”®ä¸€æ­¥ã€‚

æœ€åï¼Œé€ç»™å¤§å®¶ä¸€å¥è¯ï¼š

> **å¥½çš„æ¶æ„ä¸æ˜¯è®¾è®¡å‡ºæ¥çš„ï¼Œæ˜¯æ¼”åŒ–å‡ºæ¥çš„ã€‚ä½†å¦‚æœä½ ä¸€å¼€å§‹å°±ç”¨äº†å¯¹çš„æ¨¡å¼ï¼Œæ¼”åŒ–çš„æ–¹å‘ä¼šæ›´æ¸…æ™°ã€‚**